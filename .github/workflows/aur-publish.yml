name: Publish to AUR

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 50.1)'
        required: true

jobs:
  aur-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure git safe directory
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Get version
        id: version
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          if [ -n "$INPUT_VERSION" ]; then
            echo "version=$INPUT_VERSION" >> "$GITHUB_OUTPUT"
          else
            echo "version=${REF_NAME#v}" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish nautilus-plus to AUR
        uses: KSXGitHub/github-actions-deploy-aur@v3.0.1
        with:
          pkgname: nautilus-plus
          pkgbuild: |
            # Maintainer: Zack <zack@internetuniverse.org>
            pkgname=nautilus-plus
            pkgver=${{ steps.version.outputs.version }}
            pkgrel=1
            pkgdesc="Enhanced GNOME file manager with fast search, animated thumbnails, and more"
            arch=('x86_64')
            url="https://github.com/johnzfitch/nautilus-fork"
            license=('GPL-3.0-or-later')
            depends=('glib2' 'gtk4' 'libadwaita' 'gnome-desktop-4' 'libportal-gtk4' 'tracker3' 'gst-plugins-base-libs' 'libcloudproviders' 'gnome-autoar')
            optdepends=('search-cache: Fast trigram-indexed file search (highly recommended)')
            makedepends=('git' 'meson' 'gobject-introspection' 'libxml2' 'appstream')
            provides=('nautilus')
            conflicts=('nautilus')
            replaces=('nautilus')
            install=nautilus-plus.install
            source=("git+https://github.com/johnzfitch/nautilus-fork.git#tag=v${pkgver}")
            sha256sums=('SKIP')

            build() {
                cd "$srcdir/nautilus-fork"
                arch-meson build -D docs=false -D tests=none -D packagekit=false
                meson compile -C build
            }

            package() {
                cd "$srcdir/nautilus-fork"
                meson install -C build --destdir "$pkgdir"
            }
          commit_username: 'GitHub Actions'
          commit_email: 'actions@github.com'
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to ${{ steps.version.outputs.version }}"
          assets: |
            nautilus-plus.install
