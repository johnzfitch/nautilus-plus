name: Upstream Sync with AI Agent Pipeline

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if no changes detected'
        required: false
        default: 'false'

env:
  UPSTREAM_REPO: 'https://gitlab.gnome.org/GNOME/nautilus.git'
  UPSTREAM_BRANCH: 'main'
  FORK_BRANCH: 'main'
  FEATURE_BRANCH_PREFIX: 'upstream-sync'

jobs:
  check-upstream:
    name: Check for Upstream Updates
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
      upstream_commit: ${{ steps.check.outputs.upstream_commit }}
      current_commit: ${{ steps.check.outputs.current_commit }}

    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Add upstream remote
        env:
          UPSTREAM: ${{ env.UPSTREAM_REPO }}
          BRANCH: ${{ env.UPSTREAM_BRANCH }}
        run: |
          git remote add upstream "$UPSTREAM" || true
          git fetch upstream "$BRANCH"

      - name: Check for updates
        id: check
        env:
          BRANCH: ${{ env.UPSTREAM_BRANCH }}
          FORCE_SYNC: ${{ github.event.inputs.force_sync }}
        run: |
          UPSTREAM_COMMIT=$(git rev-parse "upstream/$BRANCH")
          CURRENT_COMMIT=$(git rev-parse HEAD)

          echo "upstream_commit=$UPSTREAM_COMMIT" >> "$GITHUB_OUTPUT"
          echo "current_commit=$CURRENT_COMMIT" >> "$GITHUB_OUTPUT"

          if [ "$UPSTREAM_COMMIT" != "$CURRENT_COMMIT" ] || [ "$FORCE_SYNC" == "true" ]; then
            echo "has_updates=true" >> "$GITHUB_OUTPUT"
            echo "Upstream has updates!"
          else
            echo "has_updates=false" >> "$GITHUB_OUTPUT"
            echo "No upstream updates"
          fi

  create-sync-pr:
    name: Create Sync PR with AI Tasks
    runs-on: ubuntu-latest
    needs: check-upstream
    if: needs.check-upstream.outputs.has_updates == 'true'

    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Add upstream remote
        env:
          UPSTREAM: ${{ env.UPSTREAM_REPO }}
          BRANCH: ${{ env.UPSTREAM_BRANCH }}
        run: |
          git remote add upstream "$UPSTREAM" || true
          git fetch upstream "$BRANCH"

      - name: Create feature branch and spec
        id: create_branch
        env:
          CURRENT_COMMIT: ${{ needs.check-upstream.outputs.current_commit }}
          UPSTREAM_COMMIT: ${{ needs.check-upstream.outputs.upstream_commit }}
          PREFIX: ${{ env.FEATURE_BRANCH_PREFIX }}
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="${PREFIX}-${TIMESTAMP}"
          git checkout -b "$BRANCH_NAME"

          echo "pr_branch=$BRANCH_NAME" >> "$GITHUB_OUTPUT"

          mkdir -p docs

          # Generate spec file using printf to avoid YAML heredoc issues
          {
            printf '# Upstream Sync Specification\n\n'
            printf 'Generated: %s\n' "$(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            printf 'Upstream Commit: %s\n' "$UPSTREAM_COMMIT"
            printf 'Current Commit: %s\n\n' "$CURRENT_COMMIT"
            printf '## Upstream Changes\n\n'
          } > "docs/UPSTREAM-SYNC-SPEC-${TIMESTAMP}.md"

          git log --oneline --graph "${CURRENT_COMMIT}..${UPSTREAM_COMMIT}" --no-merges >> "docs/UPSTREAM-SYNC-SPEC-${TIMESTAMP}.md" 2>/dev/null || echo "No commits to display" >> "docs/UPSTREAM-SYNC-SPEC-${TIMESTAMP}.md"

          {
            printf '\n## Files Changed\n\n'
          } >> "docs/UPSTREAM-SYNC-SPEC-${TIMESTAMP}.md"

          git diff --stat "${CURRENT_COMMIT}..${UPSTREAM_COMMIT}" >> "docs/UPSTREAM-SYNC-SPEC-${TIMESTAMP}.md" 2>/dev/null || echo "No file changes" >> "docs/UPSTREAM-SYNC-SPEC-${TIMESTAMP}.md"

          {
            printf '\n## AI Agent Tasks\n\n'
            printf '1. @copilot: Analyze breaking changes and compatibility\n'
            printf '2. @claude: Implement merge and resolve conflicts\n'
            printf '3. @codex: Code review and QA\n'
          } >> "docs/UPSTREAM-SYNC-SPEC-${TIMESTAMP}.md"

          echo "spec_file=docs/UPSTREAM-SYNC-SPEC-${TIMESTAMP}.md" >> "$GITHUB_OUTPUT"

      - name: Create Claude task file
        env:
          BRANCH: ${{ env.UPSTREAM_BRANCH }}
        run: |
          {
            printf '# Task: Implement Upstream Sync\n\n'
            printf '## Steps\n\n'
            printf '1. Merge upstream: git merge upstream/%s\n' "$BRANCH"
            printf '2. Resolve conflicts preserving custom features\n'
            printf '3. Run tests: meson setup build && ninja -C build test\n'
            printf '4. Update documentation\n'
            printf '5. Commit and push\n\n'
            printf '## Custom Features to Preserve\n\n'
            printf '%s\n' '- Animated WebP/GIF/APNG thumbnails'
            printf '%s\n' '- Search-cache integration'
            printf '%s\n' '- Search debounce and preview results'
            printf '%s\n' '- FUSE mount detection'
          } > .claude-task.md

      - name: Commit and push
        env:
          PR_BRANCH: ${{ steps.create_branch.outputs.pr_branch }}
          UPSTREAM_COMMIT: ${{ needs.check-upstream.outputs.upstream_commit }}
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions-bot@github.com"
          git add .
          git commit -m "spec: Upstream sync ${UPSTREAM_COMMIT:0:8}"
          git push origin "$PR_BRANCH"

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          PR_BRANCH: ${{ steps.create_branch.outputs.pr_branch }}
          UPSTREAM_COMMIT: ${{ needs.check-upstream.outputs.upstream_commit }}
          CURRENT_COMMIT: ${{ needs.check-upstream.outputs.current_commit }}
          SPEC_FILE: ${{ steps.create_branch.outputs.spec_file }}
        run: |
          {
            printf '## Automated Upstream Sync\n\n'
            printf 'Merging upstream GNOME Nautilus changes.\n\n'
            printf '%s\n' "- Upstream: ${UPSTREAM_COMMIT:0:8}"
            printf '%s\n\n' "- Current: ${CURRENT_COMMIT:0:8}"
            printf '### Spec\n\n'
            printf 'See: %s\n\n' "$SPEC_FILE"
            printf '### Custom Features to Preserve\n\n'
            printf '%s\n' '- Animated WebP/GIF/APNG thumbnails'
            printf '%s\n' '- Search-cache integration'
            printf '%s\n\n' '- FUSE mount detection'
            printf '@copilot please merge upstream/main, resolve any conflicts while preserving our custom features listed above, then mark this PR ready for review.\n'
          } > .pr-body.md

          gh pr create \
            --base main \
            --head "$PR_BRANCH" \
            --title "Upstream Sync: GNOME Nautilus ${UPSTREAM_COMMIT:0:8}" \
            --body-file .pr-body.md \
            --draft

      - name: Request Copilot assistance
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          PR_BRANCH: ${{ steps.create_branch.outputs.pr_branch }}
        run: |
          PR_NUM=$(gh pr view "$PR_BRANCH" --json number -q .number)
          gh pr comment "$PR_NUM" --body "@copilot merge upstream/main into this branch, resolve conflicts preserving our custom features (animated thumbnails, search-cache, FUSE detection), then mark ready for review."

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [check-upstream, create-sync-pr]
    if: always()

    steps:
      - name: Summary
        env:
          HAS_UPDATES: ${{ needs.check-upstream.outputs.has_updates }}
        run: |
          if [ "$HAS_UPDATES" == "true" ]; then
            echo "Upstream sync PR created"
          else
            echo "No upstream updates"
          fi
